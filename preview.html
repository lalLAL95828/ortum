<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ortum</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/iconfont.css">
    <!-- 引入bootstrap css-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    
    <script src="lib/jquery.min.js"></script>

    <!-- 引入bootstrap js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

    <script src="lib/ortumReq.js"></script>

    <style>
        /*.ortum_field_preview > .ortum_item:nth-child(2n){*/
        /*    background-color: red;*/
        /*}*/

        #ortum_preview_ModalLabel_body #ortum_field_preview > .ortum_item{
            margin-top: 2px!important;
            margin-bottom: 2px!important;
        }

        #ortum_preview_ModalLabel_body #ortum_field_preview > .ortum_item:nth-child(2n){
            background: #fafafa !important;
        }
        #ortum_preview_ModalLabel_body #ortum_field_preview > .ortum_item:nth-child(2n+1){
            background: rgba(245,244,244,1) !important;
        }
        .col,.col-2{
            padding-right: 0px;
            padding-left: 0px;
        }
    </style>

</head>
<body>

    <div id="ortum_preview_ModalLabel_body" class="container" style="margin: auto"></div>

    <div style="text-align: center" class="p-2">
        <button type="button" class="btn btn-outline-primary" id="ortum_preview_submit">提交</button>
     </div>
    

    <!--<script>
        let prev = window.opener.require("feature").getFormContentHtml("id",{id:"ortum_field",win:window.opener.document})
        $("#ortum_preview_ModalLabel_body").html(prev)
    </script>-->
    <script>
        let getDomContextFormData = function(domId){
            let formData = {}
            let form = document.getElementById(domId);  
            let elements = new Array();  
            let inputElements = form.getElementsByTagName('input');  
            let selectElements = form.getElementsByTagName('select');  
            let textareaElements = form.getElementsByTagName('textarea');

            Array.prototype.forEach.call(inputElements,(item)=>{
                if(!item.name)return;//不存在name，不进行赋值
                for(let dataKey in item.dataset){
                    if(item.dataset.hasOwnProperty(dataKey)){
                        formData[item.name+"_"+dataKey] = item.dataset[dataKey];
                    }
                }
                let type = item.type.toLowerCase();
                switch (type){
                    case "radio":
                        item.checked && (formData[item.name] = item.value);
                        break;
                    case "checkbox":
                        if(item.name && item.name.indexOf("switch") != -1){
                            item.checked && (formData[item.name] = true);
                            !item.checked && (formData[item.name] = false);
                        }else{
                            item.checked && (formData[item.name] ? formData[item.name].push(item.value) : formData[item.name]=[item.value]);
                        }
                        break;
                    default:
                        formData[item.name] = item.value;
                        break;
                }
            })

            Array.prototype.forEach.call(selectElements,(item)=>{
                if(!item.name)return;//不存在name，不进行赋值
                for(let dataKey in item.dataset){
                    if(item.dataset.hasOwnProperty(dataKey)){
                        formData[item.name+"_"+dataKey] = item.dataset[dataKey];
                    }
                }
                formData[item.name] = item.value;
            })
            Array.prototype.forEach.call(textareaElements,(item)=>{
                if(!item.name)return;//不存在name，不进行赋值
                for(let dataKey in item.dataset){
                    if(item.dataset.hasOwnProperty(dataKey)){
                        formData[item.name+"_"+dataKey] = item.dataset[dataKey];
                    }
                }
                formData[item.name] = item.value;
            })

            return formData;
        }


        $("#ortum_preview_submit").on('click',function(e){
            let formData = getDomContextFormData("ortum_preview_ModalLabel_body");
            console.log(formData)
            alert(JSON.stringify(formData))
            return false;
        })
    </script>

    <script>
        let prevArrJSON = window.opener.require("feature").getFormContentJson("id",{id:"ortum_field",win:window.opener.document})

        let prevDom = $('<div id="ortum_field_preview"></div>')
        let cssDomSet = [];
        let scriptDomSet = [];

        //从json渲染成dom
        function renderJson(prevArrJSON,parentDom,way="append") {
            for(let item of prevArrJSON){
                let htmlDom = $(item.html)
                if(item.children.length){
                    renderJson(item.children,htmlDom,"replace")
                }
                if(way=="append" && item.html){
                    parentDom.append(htmlDom)
                }
                if(way=="replace" && item.html){
                    $(parentDom).find("ortum_children").eq(0).replaceWith(item.html)
                }
                item.css && cssDomSet.push(item.css);
                item.script && scriptDomSet.push(item.script);
            }
        }
        renderJson(prevArrJSON,prevDom)
        $("#ortum_preview_ModalLabel_body").html(prevDom)
        cssDomSet.forEach((item,index)=>{
            $(document.head).append(item)
        })
        scriptDomSet.forEach((item,index)=>{
            $(document.body).append(item)
        })

    </script>

</body>
</html>